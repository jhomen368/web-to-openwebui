name: Scheduled Security Scan

on:
  schedule:
    # Run weekly on Monday at 8 AM UTC (12 AM PST / 1 AM PDT)
    - cron: '0 8 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  packages: read
  security-events: write
  issues: write

jobs:
  scan-published-images:
    name: Scan Published Docker Images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        tag: ['latest', 'main']

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/${{ github.repository }}:${{ matrix.tag }}
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ matrix.tag }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.tag }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.tag }}.sarif'
          category: 'trivy-${{ matrix.tag }}'

      - name: Check for vulnerabilities
        id: check
        run: |
          # Extract vulnerability count from Trivy SARIF
          VULN_COUNT=$(jq '.runs[0].results | length' trivy-results-${{ matrix.tag }}.sarif)
          echo "count=$VULN_COUNT" >> $GITHUB_OUTPUT

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $VULN_COUNT vulnerabilities in ${{ matrix.tag }} image"
            exit 1
          else
            echo "âœ… No critical/high vulnerabilities found in ${{ matrix.tag }} image"
          fi

      - name: Create issue if vulnerabilities found
        if: failure() && steps.check.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const vulnCount = '${{ steps.check.outputs.count }}';
            const tag = '${{ matrix.tag }}';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(`Security vulnerabilities in ${tag} image`)
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security vulnerabilities found in ${tag} image`,
                body: `## Security Scan Results

                **Image**: \`ghcr.io/${{ github.repository }}:${tag}\`
                **Vulnerabilities Found**: ${vulnCount} (CRITICAL/HIGH severity)
                **Scan Date**: ${new Date().toISOString()}

                ### Action Required

                Critical or high severity vulnerabilities have been detected in the published Docker image.

                **Next Steps**:
                1. Review the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning) for details
                2. Update vulnerable dependencies in \`requirements.txt\`
                3. Rebuild and republish the Docker image
                4. Close this issue after fixes are deployed

                **Related Workflow**: [Scheduled Security Scan](https://github.com/${{ github.repository }}/actions/workflows/security-scan-scheduled.yml)
                `,
                labels: ['security', 'automated', 'vulnerability']
              });
            }
