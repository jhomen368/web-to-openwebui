name: Scheduled Security Scan

on:
  schedule:
    # Run weekly on Monday at 8 AM UTC (12 AM PST / 1 AM PDT)
    - cron: '0 8 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  packages: read
  security-events: write

jobs:
  scan-published-images:
    name: Scan Published Docker Images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        tag: ['latest']

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/${{ github.repository }}:${{ matrix.tag }}
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ matrix.tag }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.tag }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.tag }}.sarif'
          category: 'trivy-${{ matrix.tag }}'

      - name: Check for CRITICAL vulnerabilities
        id: check
        run: |
          # Extract CRITICAL vulnerability count from Trivy SARIF
          CRIT_COUNT=$(jq '.runs[0].results[] | select(.severity == "CRITICAL") | length' trivy-results-${{ matrix.tag }}.sarif)
          echo "count=$CRIT_COUNT" >> $GITHUB_OUTPUT

          if [ "$CRIT_COUNT" -gt 0 ]; then
            echo "⚠️ Found $CRIT_COUNT CRITICAL vulnerabilities in ${{ matrix.tag }} image"
          else
            echo "✅ No CRITICAL vulnerabilities found in ${{ matrix.tag }} image"
          fi
